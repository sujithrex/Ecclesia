<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    @font-face {
      font-family: 'Vijaya';
      src: url('file:///<%= fontPath.replace(/\\/g, '/') %>') format('truetype');
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      width: 210.00mm;
      height: 297.00mm;
      position: relative;
      overflow: hidden;
      font-family: 'Times New Roman', 'Vijaya', serif;
    }
    .page {
      width: 210.00mm;
      height: 297.00mm;
      position: relative;
      page-break-after: always;
    }
    .page:last-child {
      page-break-after: auto;
    }
    .text-frame {
      position: absolute;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .text-content {
      width: 100%;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .shape {
      position: absolute;
    }
    .line {
      position: absolute;
    }
    .english-text {
      font-family: 'Times New Roman', serif;
    }
    .tamil-text {
      font-family: 'Vijaya', serif;
    }
    .bold-text {
      font-weight: bold;
    }
    @media print {
      body { margin: 0; }
      .page { page-break-after: always; }
      .page:last-child { page-break-after: auto; }
    }
  </style>
</head>
<body>
<%
// Helper functions
function formatRespect(respect) {
  if (!respect) return '';
  const respectMap = {
    'mr': 'Mr', 'mrs': 'Mrs', 'ms': 'Ms', 'master': 'Master',
    'rev': 'Rev', 'dr': 'Dr', 'er': 'Er', 'sis': 'Sis', 'bishop': 'Bishop'
  };
  return respectMap[respect.toLowerCase()] || respect;
}

// Remove leading zeros from family number
function formatFamilyNumber(familyNumber) {
  if (!familyNumber) return '';
  // Remove leading zeros but keep the number
  return familyNumber.replace(/^0+/, '') || '0';
}

// Check if text contains Tamil characters
function isTamilText(text) {
  if (!text) return false;
  // Tamil Unicode range: \u0B80-\u0BFF
  const tamilRegex = /[\u0B80-\u0BFF]/;
  return tamilRegex.test(text);
}

// Get font class based on text content
function getFontClass(text) {
  return isTamilText(text) ? 'tamil-text' : 'english-text';
}

// Get font size based on text content (Tamil gets default, English -1pt)
function getFontSize(text, baseSize) {
  return isTamilText(text) ? baseSize : (baseSize - 1);
}

// Calculate members per page - approximately 20 members fit on one page after header
const membersPerPage = 20;
const totalMembers = congregationData.reduce((sum, family) => sum + family.members.length, 0);
const totalPages = Math.ceil(totalMembers / membersPerPage);

// Flatten all members with family info
const allMembersWithFamily = [];
congregationData.forEach(familyGroup => {
  familyGroup.members.forEach(member => {
    allMembersWithFamily.push({
      family: familyGroup.family,
      area: familyGroup.area,
      member: member
    });
  });
});

for (let pageNum = 0; pageNum < totalPages; pageNum++) {
  const startIdx = pageNum * membersPerPage;
  const endIdx = Math.min(startIdx + membersPerPage, allMembersWithFamily.length);
  const membersOnPage = allMembersWithFamily.slice(startIdx, endIdx);
%>
<div class="page">
  <% if (pageNum === 0) { %>
  <!-- Header - Only on first page -->
  
  <!-- Main Title -->
  <div class="text-frame" style="left: 12.70mm; top: 16.95mm; width: 184.60mm; height: 8.05mm;">
    <div class="text-content tamil-text bold-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; font-size: 24.0pt; color: #000000; text-align: center;">சபை அங்கத்தினர் ஜாபிதா</div>
  </div>
  
  <!-- Instruction text -->
  <div class="text-frame" style="left: 11.00mm; top: 26.00mm; width: 184.60mm; height: 5.75mm;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; font-size: 12.0pt; color: #000000; text-align: center;">( ஒவ்வொரு குடும்பத்தினர்க்கும் அடுத்த குடும்பத்திற்கும் இடையில் 4 கோடுகள் விடப்படவும் )</div>
  </div>
  
  <!-- Church label and name -->
  <div class="text-frame" style="left: 15.00mm; top: 32.25mm; width: 12.25mm; height: 4.25mm;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; font-size: <%= getFontSize(church.church_name_tamil || church.church_name, 12) %>pt; color: #000000; text-align: left;">சபை :</div>
  </div>
  
  <div class="text-frame" style="left: 27.25mm; top: 32.25mm; width: 80mm; height: 4.25mm;">
    <div class="text-content <%= getFontClass(church.church_name_tamil || church.church_name) %>" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; font-size: <%= getFontSize(church.church_name_tamil || church.church_name, 12) %>pt; color: #000000; text-align: left;"><%= church.church_name_tamil || church.church_name %></div>
  </div>
  
  <!-- Year instruction -->
  <div class="text-frame" style="left: 113.75mm; top: 37.25mm; width: 83.60mm; height: 5.75mm;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: flex-start; font-size: 12.0pt; color: #000000; text-align: left;">2025 ஏப்ரலில் எழுதப்பட வேண்டியது 2025 -2026</div>
  </div>
  
  <!-- Column Headers (Rotated) -->
  
  <!-- குடும்ப எண் -->
  <div class="text-frame" style="left: 17.02mm; top: 58.87mm; margin-left: -15.21mm; margin-top: -4.11mm; width: 30.41mm; height: 8.21mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12.0pt; color: #000000; text-align: center;">குடும்ப எண்</div>
  </div>
  
  <!-- இனமுறை -->
  <div class="text-frame" style="left: 29.01mm; top: 58.91mm; margin-left: -15.34mm; margin-top: -7.17mm; width: 30.67mm; height: 14.33mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12.0pt; color: #000000; text-align: center;">இனமுறை</div>
  </div>
  
  <!-- பெயர் மற்றும் ஆதார் எண் -->
  <div class="text-frame" style="left: 36.32mm; top: 43.68mm; width: 75.85mm; height: 30.39mm;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12.0pt; color: #000000; text-align: center;">பெயர் மற்றும் ஆதார் எண்<br/>(பெயர் ஆதார் அட்டையில் உள்ளபடி)</div>
  </div>
  
  <!-- சங்கம் 2025-2026 -->
  <div class="text-frame" style="left: 116.46mm; top: 59.09mm; margin-left: -15.34mm; margin-top: -4.11mm; width: 30.67mm; height: 8.21mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12.0pt; color: #000000; text-align: center;">சங்கம் <%= options.year || new Date().getFullYear() %>-<%= (options.year || new Date().getFullYear()) + 1 %></div>
  </div>
  
  <!-- வயது (Age) -->
  <div class="text-frame" style="left: 120.75mm; top: 43.93mm; width: 25.57mm; height: 7.20mm;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12.0pt; color: #000000; text-align: center;">வயது</div>
  </div>
  
  <!-- Age sub-headers -->
  <!-- 1-15 -->
  <div class="text-frame" style="left: 124.86mm; top: 62.77mm; margin-left: -11.47mm; margin-top: -4.07mm; width: 22.95mm; height: 8.13mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12.0pt; color: #000000; text-align: center;">1-15</div>
  </div>
  
  <!-- 16-35 -->
  <div class="text-frame" style="left: 133.34mm; top: 62.60mm; margin-left: -11.47mm; margin-top: -4.07mm; width: 22.95mm; height: 8.13mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12.0pt; color: #000000; text-align: center;">16-35</div>
  </div>
  
  <!-- 35க்கு மேல் -->
  <div class="text-frame" style="left: 141.91mm; top: 62.60mm; margin-left: -11.47mm; margin-top: -4.07mm; width: 22.95mm; height: 8.13mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12.0pt; color: #000000; text-align: center;">35க்கு மேல்</div>
  </div>
  
  <!-- ஆ.பெ.பி -->
  <div class="text-frame" style="left: 150.32mm; top: 59.00mm; margin-left: -15.07mm; margin-top: -4.17mm; width: 30.15mm; height: 8.35mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12.0pt; color: #000000; text-align: center;">ஆ.பெ.பி</div>
  </div>
  
  <!-- வரிசை எண் -->
  <div class="text-frame" style="left: 158.93mm; top: 59.07mm; margin-left: -15.07mm; margin-top: -4.17mm; width: 30.15mm; height: 8.35mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12.0pt; color: #000000; text-align: center;">வரிசை எண்</div>
  </div>
  
  <!-- ஞானஸ்நானம் -->
  <div class="text-frame" style="left: 167.53mm; top: 59.00mm; margin-left: -15.07mm; margin-top: -4.17mm; width: 30.15mm; height: 8.35mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12.0pt; color: #000000; text-align: center;">ஞானஸ்நானம்</div>
  </div>
  
  <!-- இராபோஜனம் -->
  <div class="text-frame" style="left: 176.13mm; top: 59.35mm; margin-left: -15.07mm; margin-top: -4.17mm; width: 30.15mm; height: 8.35mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12.0pt; color: #000000; text-align: center;">இராபோஜனம்</div>
  </div>
  
  <!-- அயலிடம் -->
  <div class="text-frame" style="left: 184.50mm; top: 59.00mm; margin-left: -15.07mm; margin-top: -4.17mm; width: 30.15mm; height: 8.35mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12.0pt; color: #000000; text-align: center;">அயலிடம்</div>
  </div>
  
  <!-- குறிப்புகள் -->
  <div class="text-frame" style="left: 192.88mm; top: 58.82mm; margin-left: -15.07mm; margin-top: -4.17mm; width: 30.15mm; height: 8.35mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12.0pt; color: #000000; text-align: center;">குறிப்புகள்</div>
  </div>
  
  <!-- Border and Lines -->
  <div class="shape" style="left: 12.70mm; top: 12.70mm; width: 184.60mm; height: 271.60mm; border: 0.35mm solid #000000;"></div>
  
  <!-- Horizontal lines -->
  <svg class="line" style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none;">
    <line x1="12.92mm" y1="36.50mm" x2="197.06mm" y2="36.50mm" stroke="#000000" stroke-width="0.35mm" />
    <line x1="12.92mm" y1="43.75mm" x2="197.12mm" y2="43.75mm" stroke="#000000" stroke-width="0.35mm" />
    <line x1="120.40mm" y1="51.30mm" x2="145.97mm" y2="51.30mm" stroke="#000000" stroke-width="0.35mm" />
    <line x1="12.92mm" y1="74.25mm" x2="197.14mm" y2="74.25mm" stroke="#000000" stroke-width="0.35mm" />
    <line x1="35.99mm" y1="83.25mm" x2="112.27mm" y2="83.25mm" stroke="#000000" stroke-width="0.35mm" />
  </svg>
  
  <!-- Vertical lines -->
  <svg class="line" style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none;">
    <line x1="21.30mm" y1="43.68mm" x2="21.30mm" y2="284.30mm" stroke="#000000" stroke-width="0.35mm" />
    <line x1="36.00mm" y1="43.75mm" x2="36.00mm" y2="284.30mm" stroke="#000000" stroke-width="0.35mm" />
    <line x1="112.18mm" y1="36.32mm" x2="112.18mm" y2="284.30mm" stroke="#000000" stroke-width="0.35mm" />
    <line x1="120.58mm" y1="43.57mm" x2="120.58mm" y2="284.30mm" stroke="#000000" stroke-width="0.35mm" />
    <line x1="129.10mm" y1="51.12mm" x2="129.10mm" y2="284.30mm" stroke="#000000" stroke-width="0.35mm" />
    <line x1="137.62mm" y1="51.12mm" x2="137.62mm" y2="284.30mm" stroke="#000000" stroke-width="0.35mm" />
    <line x1="146.15mm" y1="43.57mm" x2="146.15mm" y2="284.30mm" stroke="#000000" stroke-width="0.35mm" />
    <line x1="154.67mm" y1="43.57mm" x2="154.67mm" y2="284.30mm" stroke="#000000" stroke-width="0.35mm" />
    <line x1="163.19mm" y1="43.57mm" x2="163.19mm" y2="284.30mm" stroke="#000000" stroke-width="0.35mm" />
    <line x1="171.72mm" y1="43.57mm" x2="171.72mm" y2="284.30mm" stroke="#000000" stroke-width="0.35mm" />
    <line x1="180.24mm" y1="43.57mm" x2="180.24mm" y2="284.30mm" stroke="#000000" stroke-width="0.35mm" />
    <line x1="188.76mm" y1="43.57mm" x2="188.76mm" y2="284.30mm" stroke="#000000" stroke-width="0.35mm" />
  </svg>
  <% } %>

  <%
  // Draw member rows
  const firstMemberTop = pageNum === 0 ? 74.25 : 20; // Start lower on first page due to header
  const memberRowHeight = 9.0; // Space between member rows
  let currentY = firstMemberTop;
  let previousFamilyId = null;

  membersOnPage.forEach((item, idx) => {
    const family = item.family;
    const member = item.member;
    const area = item.area;

    // Check if this is a new family (first member of family)
    const isFirstMemberOfFamily = previousFamilyId !== family.id;
    previousFamilyId = family.id;

    // Family Number (combined area_identity + family_number) - remove leading zeros
    const rawFamilyNumber = family.combined_family_number || `${area?.area_identity || ''}${family.family_number}`;
    const familyNumber = formatFamilyNumber(rawFamilyNumber);

    // Member name with respect (no dot after respect since formatRespect doesn't include it)
    const memberName = `${formatRespect(member.respect)}. ${member.name}`;
    const nameClass = getFontClass(memberName);
    const nameFontSize = getFontSize(memberName, 12);

    // Aadhar number
    const aadharNumber = member.aadhar_number || '';

    // Age
    const age = member.age || '';

    // Category (ஆ/பெ/பி)
    const category = member.category || '';

    // Serial number
    const serialNumber = member.serial_number || '';

    // Baptised (X if yes)
    const baptised = member.is_baptised === 'yes' ? 'X' : '';

    // Confirmed (X if yes)
    const confirmed = member.is_confirmed === 'yes' ? 'X' : '';

    // Relation
    const relation = member.relation || '';
  %>

  <!-- Family Number (only show for first member of family) - 70% font size -->
  <% if (isFirstMemberOfFamily) { %>
  <div class="text-frame" style="left: 12.70mm; top: <%= currentY %>mm; width: 8.60mm; height: <%= memberRowHeight %>mm;">
    <div class="text-content english-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 7.7pt; color: #000000; text-align: center;"><%= familyNumber %></div>
  </div>
  <% } %>

  <!-- Relation (இனமுறை) -->
  <div class="text-frame" style="left: 21.48mm; top: <%= currentY %>mm; width: 14.70mm; height: <%= memberRowHeight %>mm;">
    <div class="text-content <%= getFontClass(relation) %>" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: <%= getFontSize(relation, 10) %>pt; color: #000000; text-align: center;"><%= relation %></div>
  </div>

  <!-- Member Name -->
  <div class="text-frame" style="left: 37.00mm; top: <%= currentY %>mm; width: 75.28mm; height: <%= memberRowHeight %>mm;">
    <div class="text-content <%= nameClass %>" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: flex-start; font-size: <%= nameFontSize %>pt; color: #000000; text-align: left;"><%= memberName %></div>
  </div>

  <!-- Aadhar Number (below name in same cell) -->
  <% if (aadharNumber) { %>
  <div class="text-frame" style="left: 37.00mm; top: <%= currentY + 4.5 %>mm; width: 75.28mm; height: 4mm;">
    <div class="text-content english-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: flex-start; font-size: 9.0pt; color: #000000; text-align: left;">(<%= aadharNumber %>)</div>
  </div>
  <% } %>

  <!-- Sangam (always 300) -->
  <div class="text-frame" style="left: 116.38mm; top: <%= currentY + 4 %>mm; margin-left: -8.79mm; margin-top: -4.03mm; width: 17.58mm; height: 8.05mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content english-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12.0pt; color: #000000; text-align: center;">300</div>
  </div>

  <!-- Age (in appropriate column based on age range) -->
  <%
  let ageColumnLeft = 124.86; // Default column for 1-15
  if (age <= 15) {
    ageColumnLeft = 124.86;
  } else if (age >= 16 && age <= 35) {
    ageColumnLeft = 133.34;
  } else if (age > 35) {
    ageColumnLeft = 141.91;
  }
  %>
  <div class="text-frame" style="left: <%= ageColumnLeft %>mm; top: <%= currentY + 4 %>mm; margin-left: -8.79mm; margin-top: -4.03mm; width: 17.58mm; height: 8.05mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content english-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 11.0pt; color: #000000; text-align: center;"><%= age %></div>
  </div>

  <!-- Category (ஆ/பெ/பி) -->
  <div class="text-frame" style="left: 150.47mm; top: <%= currentY + 4 %>mm; margin-left: -8.79mm; margin-top: -4.03mm; width: 17.58mm; height: 8.05mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content tamil-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 12.0pt; color: #000000; text-align: center;"><%= category %></div>
  </div>

  <!-- Serial Number -->
  <div class="text-frame" style="left: 158.99mm; top: <%= currentY + 4 %>mm; margin-left: -8.79mm; margin-top: -4.03mm; width: 17.58mm; height: 8.05mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content english-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 11.0pt; color: #000000; text-align: center;"><%= serialNumber %></div>
  </div>

  <!-- Baptised (ஞானஸ்நானம்) -->
  <div class="text-frame" style="left: 167.53mm; top: <%= currentY + 4 %>mm; margin-left: -8.79mm; margin-top: -4.03mm; width: 17.58mm; height: 8.05mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content english-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 11.0pt; color: #000000; text-align: center;"><%= baptised %></div>
  </div>

  <!-- Confirmed (இராபோஜனம்) -->
  <div class="text-frame" style="left: 176.13mm; top: <%= currentY + 4 %>mm; margin-left: -8.79mm; margin-top: -4.03mm; width: 17.58mm; height: 8.05mm; transform: rotate(-90deg); transform-origin: center center;">
    <div class="text-content english-text" style="width: 100%; height: 100%; box-sizing: border-box; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 11.0pt; color: #000000; text-align: center;"><%= confirmed %></div>
  </div>

  <!-- Row separator line -->
  <svg class="line" style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none;">
    <line x1="12.70mm" y1="<%= currentY + memberRowHeight %>mm" x2="197.35mm" y2="<%= currentY + memberRowHeight %>mm" stroke="#000000" stroke-width="0.35mm" />
  </svg>

  <%
    currentY += memberRowHeight;
  });
  %>
</div>
<% } %>
</body>
</html>

